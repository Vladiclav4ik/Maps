{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Загрузите карту</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 80vh; width: 100%; }
    .handle {
      width: 12px;
      height: 12px;
      background-color: red;
      border: 2px solid white;
      border-radius: 50%;
    }
  </style>
</head>
<body>

<h2>Загрузите изображение и укажите его на карте</h2>

<form method="post" enctype="multipart/form-data" id="mapForm">
  {% csrf_token %}
  {{ form.as_p }}

  <input type="hidden" name="nw_lat" id="nw_lat">
  <input type="hidden" name="nw_lng" id="nw_lng">
  <input type="hidden" name="ne_lat" id="ne_lat">
  <input type="hidden" name="ne_lng" id="ne_lng">
  <input type="hidden" name="sw_lat" id="sw_lat">
  <input type="hidden" name="sw_lng" id="sw_lng">

  <button type="submit">Сохранить</button>
</form>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
{% load static %}
<script src="{% static 'js/leaflet.js' %}"></script>

<script>

let map = L.map('map').setView([59.93, 30.31], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let imageUrl = null;
let imageOverlay = null;
let cornerMarkers = [];

function createOverlayFromCorners() {
  if (!imageUrl || cornerMarkers.length !== 3) return;
  if (imageOverlay) map.removeLayer(imageOverlay);
  let nw = cornerMarkers[0].getLatLng();
  let ne = cornerMarkers[1].getLatLng();
  let sw = cornerMarkers[2].getLatLng();
  imageOverlay = new L.ImageOverlay.Rotated(imageUrl, nw, ne, sw, { opacity: 0.7 }).addTo(map);
}

function createDraggableCorners(bounds) {
  cornerMarkers.forEach(m => map.removeLayer(m));
  cornerMarkers = [];
  let [nw, ne, sw] = [bounds.getNorthWest(), bounds.getNorthEast(), bounds.getSouthWest()];
  [nw, ne, sw].forEach((corner, i) => {
    let marker = L.marker(corner, {
      draggable: true,
      icon: L.divIcon({ className: 'handle' })
    }).addTo(map).on('drag', createOverlayFromCorners);
    cornerMarkers.push(marker);
  });
}

document.getElementById('id_image').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    imageUrl = event.target.result;
    createDraggableCorners(map.getBounds());
    createOverlayFromCorners();
  };
  reader.readAsDataURL(file);
});

document.getElementById('mapForm').addEventListener('submit', function() {
  if (cornerMarkers.length === 3) {
    let [nw, ne, sw] = cornerMarkers.map(m => m.getLatLng());
    document.getElementById('nw_lat').value = nw.lat;
    document.getElementById('nw_lng').value = nw.lng;
    document.getElementById('ne_lat').value = ne.lat;
    document.getElementById('ne_lng').value = ne.lng;
    document.getElementById('sw_lat').value = sw.lat;
    document.getElementById('sw_lng').value = sw.lng;
  }
});
</script>
</body>
</html>
