<!DOCTYPE html>
<html lang="ru">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <title>Редактирование карты</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="{% static 'static/main.css' %}">
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      padding: 24px 0 12px;
      color: #222;
    }

    .container {
      flex: 1;
      width: 1400px;
      margin: 0 auto;
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 30px;
      overflow: hidden;
    }

    /* Основной блок с картой и формой */
    .map-container {
      flex: 1;
      display: flex;
      gap: 30px;
      min-height: 0;
      overflow: hidden;
    }

    /* Левая часть - карта */
    .map-wrapper {
      flex: 2;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      border: 1px solid #ddd;
      overflow: hidden;
      min-height: 400px;
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 12px;
    }

    /* Правая панель с формой */
    .sidebar {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.05);
      padding: 24px;
      overflow-y: auto;
    }

    /* Общие стили для формы */
    form p {
      margin: 0 0 20px 0;
      display: flex;
      flex-direction: column;
    }

    form p label {
      font-weight: 600;
      font-size: 14px;
      color: #444;
      margin-bottom: 6px;
    }

    /* Поля ввода */
    input[type="text"],
    textarea,
    select {
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid #bbb;
      border-radius: 10px;
      font-family: inherit;
      color: #333;
      background-color: #fff;
      box-sizing: border-box;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      border-color: #007BFF;
      box-shadow: 0 0 8px rgba(0,123,255,0.4);
      outline: none;
    }

    textarea {
      min-height: 120px;
      max-height: 120px;
      resize: none;
      line-height: 1.4;
      color: #444;
    }

    /* Стилизация для select с кастомной стрелкой */
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3csvg fill='gray' height='16' viewBox='0 0 24 24' width='16' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 16px 16px;
      cursor: pointer;
      padding-right: 44px;
    }

    /* Кнопки */
    form button {
      padding: 14px 24px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      background-color: #007BFF;
      color: white;
      cursor: pointer;
      max-width: 240px;
      transition: background-color 0.3s ease;
      align-self: flex-start;
      margin-top: 10px;
    }

    form button:hover {
      background-color: #0056b3;
    }

    /* Контейнер кнопок */
    .action-buttons {
      display: flex;
      gap: 16px;
      margin-top: 20px;
      align-items: center;
    }

    .action-buttons a {
      padding: 12px 24px;
      background-color: #f0f0f0;
      color: #333;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-decoration: none;
      font-size: 16px;
      transition: background-color 0.2s ease;
    }

    .action-buttons a:hover {
      background-color: #ddd;
    }

    /* Маркеры на карте */
    .handle {
      width: 14px;
      height: 14px;
      background-color: red;
      border: 2px solid white;
      border-radius: 50%;
    }

    .footer-buttons {
      text-align: center;
      padding: 30px;
      background: #fff;
      border-top: 1px solid #eee;
    }

    .footer-buttons a {
      padding: 12px 24px;
      background: #007BFF;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 16px;
      transition: background 0.2s ease;
    }

    .footer-buttons a:hover {
      background: #0056b3;
    }

    form button {
      width: auto;             /* ширина по содержимому */
      max-width: 240px;        /* ограничение ширины */
      display: block;          /* чтобы margin-auto сработал */
      margin: auto;            /* по вертикали и горизонтали центр */
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    form button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>✏️ Редактирование положения карты</h1>
    <div class="map-container">
      <div class="map-wrapper">
        <div id="map"></div>
      </div>
      <div class="sidebar">
        <form method="post" id="mapForm">
          {% csrf_token %}
          {{ form.as_p }}

          <input type="hidden" name="nw_lat" id="nw_lat" value="{{ map.nw_lat }}">
          <input type="hidden" name="nw_lng" id="nw_lng" value="{{ map.nw_lng }}">
          <input type="hidden" name="ne_lat" id="ne_lat" value="{{ map.ne_lat }}">
          <input type="hidden" name="ne_lng" id="ne_lng" value="{{ map.ne_lng }}">
          <input type="hidden" name="sw_lat" id="sw_lat" value="{{ map.sw_lat }}">
          <input type="hidden" name="sw_lng" id="sw_lng" value="{{ map.sw_lng }}">

          <div class="action-buttons">
            <button type="submit">Сохранить изменения</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="footer-buttons">
    <a href="{% url 'map_detail' map.id %}">← Отмена</a>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="{% static 'js/leaflet.js' %}"></script>

  <script>
    let map = L.map('map').setView([59.93, 30.31], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    map.attributionControl.setPrefix('Mysite');

    let imageUrl = "{{ map.image.url }}";

    let imageOverlay = null;
    let cornerMarkers = [];

    function createOverlayFromCorners() {
      if (!imageUrl || cornerMarkers.length !== 3) return;
      if (imageOverlay) map.removeLayer(imageOverlay);
      let nw = cornerMarkers[0].getLatLng();
      let ne = cornerMarkers[1].getLatLng();
      let sw = cornerMarkers[2].getLatLng();
      imageOverlay = new L.ImageOverlay.Rotated(imageUrl, nw, ne, sw, { opacity: 0.7 }).addTo(map);
    }

    function createDraggableCorners(nw, ne, sw) {
      cornerMarkers.forEach(m => map.removeLayer(m));
      cornerMarkers = [];
      [nw, ne, sw].forEach((corner) => {
        let marker = L.marker(corner, {
          draggable: true,
          icon: L.divIcon({ className: 'handle' })
        }).addTo(map).on('drag', createOverlayFromCorners);
        cornerMarkers.push(marker);
      });
    }

    const initialNW = L.latLng(parseFloat(document.getElementById('nw_lat').value), parseFloat(document.getElementById('nw_lng').value));
    const initialNE = L.latLng(parseFloat(document.getElementById('ne_lat').value), parseFloat(document.getElementById('ne_lng').value));
    const initialSW = L.latLng(parseFloat(document.getElementById('sw_lat').value), parseFloat(document.getElementById('sw_lng').value));

    createDraggableCorners(initialNW, initialNE, initialSW);
    createOverlayFromCorners();
    map.fitBounds(L.latLngBounds([initialNW, initialNE, initialSW]));

    document.getElementById('mapForm').addEventListener('submit', function() {
      if (cornerMarkers.length === 3) {
        let [nw, ne, sw] = cornerMarkers.map(m => m.getLatLng());
        document.getElementById('nw_lat').value = nw.lat;
        document.getElementById('nw_lng').value = nw.lng;
        document.getElementById('ne_lat').value = ne.lat;
        document.getElementById('ne_lng').value = ne.lng;
        document.getElementById('sw_lat').value = sw.lat;
        document.getElementById('sw_lng').value = sw.lng;
      }
    });
  </script>
</body>
</html>
